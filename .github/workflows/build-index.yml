name: Build index.json

on:
  push:
    paths:
      - 'docs/Extractor/**/*.md'
      - 'docs/Narrator/**/*.md'
  workflow_dispatch:

jobs:
  build-index:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Build Extractor index.json
        run: |
          for layer_dir in docs/Extractor/*/; do
            layer_name="$(basename "$layer_dir")"
            index_file="${layer_dir}index.json"
            echo "ðŸ“‹ Building index: $layer_name"

            # æ”¶é›†æ‰€æœ‰ .md æª”æ¡ˆçš„ metadata
            items="[]"

            while IFS= read -r md_file; do
              [ -z "$md_file" ] && continue

              rel_path="${md_file#${layer_dir}}"
              title="$(grep -m1 '^# ' "$md_file" 2>/dev/null | sed 's/^# //' || echo "")"
              category="$(dirname "$rel_path")"
              [ "$category" = "." ] && category="other"

              # å¾žè¡¨æ ¼ä¸­æå–æ¬„ä½
              date_val="$(grep -m1 '\*\*æ—¥æœŸ\*\*' "$md_file" 2>/dev/null | sed 's/.*| *//; s/ *|.*//' || echo "")"
              source_val="$(grep -m1 '\*\*ä¾†æº\*\*' "$md_file" 2>/dev/null | sed 's/.*| *//; s/ *|.*//' || echo "")"
              severity="$(grep -m1 '\*\*åš´é‡ç¨‹åº¦\*\*' "$md_file" 2>/dev/null | sed 's/.*| *//; s/ *|.*//' || echo "")"

              items="$(echo "$items" | jq \
                --arg title "$title" \
                --arg date "$date_val" \
                --arg file "$rel_path" \
                --arg category "$category" \
                --arg source "$source_val" \
                --arg severity "$severity" \
                --arg layer "$layer_name" \
                '. + [{
                  id: ($file | gsub("[/.]"; "-")),
                  title: $title,
                  category: $category,
                  date: $date,
                  file: $file,
                  source: $source,
                  severity: $severity,
                  source_layer: $layer
                }]'
              )"
            done < <(find "$layer_dir" -name "*.md" -type f 2>/dev/null | sort -r)

            echo "$items" | jq '.' > "$index_file"
            echo "âœ… $layer_name: $(echo "$items" | jq 'length') ç­†"
          done

      - name: Build Narrator index.json
        run: |
          for mode_dir in docs/Narrator/*/; do
            mode_name="$(basename "$mode_dir")"
            index_file="${mode_dir}index.json"
            echo "ðŸ“‹ Building index: $mode_name"

            items="[]"

            while IFS= read -r md_file; do
              [ -z "$md_file" ] && continue

              rel_path="${md_file#${mode_dir}}"
              title="$(grep -m1 '^# ' "$md_file" 2>/dev/null | sed 's/^# //' || echo "")"

              # å¾žå ±å‘Šé ­éƒ¨æå–æ¶µè“‹æœŸé–“
              period="$(grep -m1 'æ¶µè“‹æœŸé–“' "$md_file" 2>/dev/null | sed 's/.*æ¶µè“‹æœŸé–“[ï¼š:] *//' || echo "")"
              date_val="$(echo "$rel_path" | grep -oE '[0-9]{4}-W[0-9]{2}' || echo "")"

              items="$(echo "$items" | jq \
                --arg title "$title" \
                --arg date "$date_val" \
                --arg file "$rel_path" \
                --arg period "$period" \
                --arg mode "$mode_name" \
                '. + [{
                  id: ($file | gsub("[/.]"; "-")),
                  title: $title,
                  date: $date,
                  period: $period,
                  file: $file,
                  source_mode: $mode
                }]'
              )"
            done < <(find "$mode_dir" -name "*.md" -type f 2>/dev/null | sort -r)

            echo "$items" | jq '.' > "$index_file"
            echo "âœ… $mode_name: $(echo "$items" | jq 'length') ç­†"
          done

      - name: Commit index.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/*/index.json docs/*/*/index.json
          if git diff --cached --quiet; then
            echo "No changes to index.json"
          else
            git commit -m "chore: auto-update index.json"
            git push
          fi
