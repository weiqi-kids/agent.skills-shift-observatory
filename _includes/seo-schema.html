{% comment %}
SEO JSON-LD Schema 生成器
根據頁面 front matter + _data/seo.yml 生成結構化資料

使用方式：在 _layouts/default.html 的 <head> 中加入：
{% include seo-schema.html %}
{% endcomment %}

{% assign seo_data = site.data.seo %}
{% assign page_url = page.url | absolute_url %}
{% assign site_url = site.url %}

{% comment %} 計算日期 {% endcomment %}
{% if page.generated_at %}
  {% assign pub_date = page.generated_at | date: "%Y-%m-%d" %}
{% elsif page.date %}
  {% assign pub_date = page.date | date: "%Y-%m-%d" %}
{% else %}
  {% assign pub_date = site.time | date: "%Y-%m-%d" %}
{% endif %}

{% comment %} 取得 SEO 標題和描述 {% endcomment %}
{% if page.seo.title %}
  {% assign seo_title = page.seo.title %}
{% elsif page.report_title %}
  {% assign seo_title = page.report_title %}
{% else %}
  {% assign seo_title = page.title | append: " | " | append: site.title %}
{% endif %}

{% if page.seo.description %}
  {% assign seo_description = page.seo.description %}
{% elsif page.description %}
  {% assign seo_description = page.description %}
{% else %}
  {% assign seo_description = site.description %}
{% endif %}

{% comment %} 取得 OG 圖片 {% endcomment %}
{% if page.seo.og_image %}
  {% assign og_image = page.seo.og_image %}
{% else %}
  {% assign og_image = seo_data.images.default_og_image %}
{% endif %}

{% comment %} 取得文章分類 {% endcomment %}
{% if page.seo.article_section %}
  {% assign article_section = page.seo.article_section %}
{% elsif page.mode %}
  {% assign article_section = seo_data.article_sections[page.mode] %}
{% else %}
  {% assign article_section = "就業市場分析" %}
{% endif %}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {% comment %} ========== WebSite Schema ========== {% endcomment %}
    {
      "@type": "WebSite",
      "@id": "{{ site_url }}#website",
      "name": "{{ seo_data.site.name }}",
      "alternateName": "{{ seo_data.site.name_zh }}",
      "url": "{{ site_url }}",
      "description": "{{ seo_data.site.description }}",
      "inLanguage": "{{ seo_data.site.language }}",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "{{ seo_data.site.search_url }}",
        "query-input": "required name=search_term"
      }
    },

    {% comment %} ========== Organization Schema ========== {% endcomment %}
    {
      "@type": "Organization",
      "@id": "{{ site_url }}#organization",
      "name": "{{ seo_data.organization.name }}",
      "url": "{{ seo_data.organization.url }}",
      "logo": {
        "@type": "ImageObject",
        "url": "{{ seo_data.organization.logo.url }}",
        "width": {{ seo_data.organization.logo.width }},
        "height": {{ seo_data.organization.logo.height }}
      },
      "sameAs": [{% for social in seo_data.organization.social %}"{{ social }}"{% unless forloop.last %}, {% endunless %}{% endfor %}],
      "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "{{ seo_data.organization.contact.type }}",
        "email": "{{ seo_data.organization.contact.email }}"
      }
    },

    {% comment %} ========== Person Schema (Author) ========== {% endcomment %}
    {
      "@type": "Person",
      "@id": "{{ seo_data.default_author.url }}#person",
      "name": "{{ seo_data.default_author.name }}",
      "url": "{{ seo_data.default_author.url }}",
      "description": "{{ seo_data.default_author.description }}",
      "knowsAbout": [{% for skill in seo_data.default_author.knows_about %}"{{ skill }}"{% unless forloop.last %}, {% endunless %}{% endfor %}],
      "hasCredential": [
        {% for cred in seo_data.default_author.credentials %}
        {
          "@type": "EducationalOccupationalCredential",
          "name": "{{ cred.name }}",
          "credentialCategory": "{{ cred.category }}"
        }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ],
      "sameAs": [{% for social in seo_data.default_author.social %}"{{ social }}"{% unless forloop.last %}, {% endunless %}{% endfor %}]
    },

    {% comment %} ========== WebPage Schema ========== {% endcomment %}
    {
      "@type": "WebPage",
      "@id": "{{ page_url }}#webpage",
      "url": "{{ page_url }}",
      "name": "{{ seo_title }}",
      "description": "{{ seo_description }}",
      "inLanguage": "{{ seo_data.site.language }}",
      "isPartOf": { "@id": "{{ site_url }}#website" },
      "primaryImageOfPage": {
        "@type": "ImageObject",
        "url": "{{ og_image }}"
      },
      "datePublished": "{{ pub_date }}",
      "dateModified": "{{ pub_date }}",
      "speakable": {
        "@type": "SpeakableSpecification",
        "cssSelector": [{% for sel in seo_data.speakable_selectors %}"{{ sel }}"{% unless forloop.last %}, {% endunless %}{% endfor %}]
      }
    },

    {% comment %} ========== Article Schema (for reports) ========== {% endcomment %}
    {% if page.report_title or page.mode %}
    {
      "@type": "Article",
      "@id": "{{ page_url }}#article",
      "mainEntityOfPage": {
        "@id": "{{ page_url }}#webpage"
      },
      "headline": "{{ seo_title | truncate: 110 }}",
      "description": "{{ seo_description }}",
      "image": {
        "@type": "ImageObject",
        "url": "{{ og_image }}",
        "width": {{ seo_data.images.og_image_width }},
        "height": {{ seo_data.images.og_image_height }}
      },
      "author": { "@id": "{{ seo_data.default_author.url }}#person" },
      "publisher": { "@id": "{{ site_url }}#organization" },
      "datePublished": "{{ pub_date }}",
      "dateModified": "{{ pub_date }}",
      "articleSection": "{{ article_section }}",
      {% if page.seo.keywords %}
      "keywords": "{% for kw in page.seo.keywords %}{{ kw }}{% unless forloop.last %}, {% endunless %}{% endfor %}",
      {% endif %}
      "inLanguage": "{{ seo_data.site.language }}",
      "isAccessibleForFree": true,
      "isPartOf": {
        "@type": "WebSite",
        "@id": "{{ site_url }}#website"
      }
    },
    {% endif %}

    {% comment %} ========== BreadcrumbList Schema ========== {% endcomment %}
    {
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "{{ seo_data.breadcrumb.home.name }}",
          "item": "{{ site_url }}{{ seo_data.breadcrumb.home.url }}"
        }
        {% if page.mode %}
        ,{
          "@type": "ListItem",
          "position": 2,
          "name": "{{ seo_data.breadcrumb.reports[page.mode].name | default: page.parent }}",
          "item": "{{ site_url }}{{ seo_data.breadcrumb.reports[page.mode].url }}"
        }
        ,{
          "@type": "ListItem",
          "position": 3,
          "name": "{{ page.title }}",
          "item": "{{ page_url }}"
        }
        {% elsif page.parent %}
        ,{
          "@type": "ListItem",
          "position": 2,
          "name": "{{ page.parent }}",
          "item": "{{ page.url | split: '/' | pop | join: '/' | prepend: site_url }}"
        }
        ,{
          "@type": "ListItem",
          "position": 3,
          "name": "{{ page.title }}",
          "item": "{{ page_url }}"
        }
        {% endif %}
      ]
    },

    {% comment %} ========== ImageObject Schema ========== {% endcomment %}
    {
      "@type": "ImageObject",
      "@id": "{{ page_url }}#primaryimage",
      "url": "{{ og_image }}",
      "width": {{ seo_data.images.og_image_width }},
      "height": {{ seo_data.images.og_image_height }},
      "caption": "{{ seo_title }}",
      "representativeOfPage": true,
      "license": "{{ seo_data.images.license_url }}",
      "creditText": "{{ seo_data.images.credit_text }}"
    }

    {% comment %} ========== FAQPage Schema (if FAQ exists) ========== {% endcomment %}
    {% if page.seo.faq and page.seo.faq.size > 0 %}
    ,{
      "@type": "FAQPage",
      "mainEntity": [
        {% for qa in page.seo.faq %}
        {
          "@type": "Question",
          "name": "{{ qa.question }}",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "{{ qa.answer | strip_html | strip_newlines }}"
          }
        }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]
    }
    {% endif %}
  ]
}
</script>
